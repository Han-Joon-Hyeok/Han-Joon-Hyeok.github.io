<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.0" /><meta property="og:title" content="[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정" /><meta name="author" content="Joon Hyeok Han" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="개요" /><meta property="og:description" content="개요" /><link rel="canonical" href="https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/" /><meta property="og:url" content="https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/" /><meta property="og:site_name" content="Dev Joon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-02-09T18:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Joon Hyeok Han" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joon Hyeok Han"},"dateModified":"2025-02-09T18:00:00+09:00","datePublished":"2025-02-09T18:00:00+09:00","description":"개요","headline":"[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정","mainEntityOfPage":{"@type":"WebPage","@id":"https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/"},"url":"https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/"}</script><title>[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정 | Dev Joon</title><link rel="shortcut icon" href="/assets/images/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/images/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/images/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/images/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/images/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/images/favicons/manifest.json"><meta name='msapplication-config' content='/assets/images/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SKST7KNWSJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SKST7KNWSJ'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dev Joon</a></div><div class="site-subtitle font-italic">성장하는 개발자, 한준혁입니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Han-Joon-Hyeok" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['joonhyeok.han','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Feb 9, 2025, 6:00 PM +0900" > Feb 9, 2025 <i class="unloaded">2025-02-09T18:00:00+09:00</i> </span> by <span class="author"> Joon Hyeok Han </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2623 words">14 min</span></div></div><div class="post-content"><h1 id="개요">개요</h1><p>nginx를 이용해 API 요청을 백엔드로 리버스 프록싱했지만, 프론트엔드에서 백엔드로 보낸 요청의 응답으로 <code class="language-plaintext highlighter-rouge">503 Service Unavailable</code>오류를 반환하는 문제가 발생했습니다. 이 글에서는 해당 오류의 원인과 해결 과정을 정리했습니다.</p><p>결론부터 말하자면, 문제의 원인은 DDoS 공격을 방지하기 위해 사용했던 nginx의 rate limit 기능과 프론트엔드의 API 요청 횟수로 인해 발생한 문제였습니다. nginx가 일정 시간 안에 처리할 수 있는 요청보다 프론트엔드에서 더 많은 요청을 보낸 것이 원인이었습니다.</p><h1 id="개발-환경">개발 환경</h1><ul><li>OS: Amazon Linux 2023 (AWS EC2)<li>Frontend: Next.js (14.0.4) + TypeScript<li>Backend: Spring Boot (3.2.3) + Java17<li>nginx: 1.26.2</ul><h1 id="문제-상황">문제 상황</h1><p>배포된 서비스에서 프론트엔드 화면을 확인하던 중, 본인이 작성한 게시물에 ‘게시물 수정’ 버튼이 표시되지 않거나 간헐적으로 표시되는 현상을 발견했습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/1.png" alt="1.png" /></p><p>로컬 개발 환경에서는 정상적으로 표시되었지만, 운영 서버에서만 해당 현상이 발생했습니다.</p><h1 id="문제-원인-분석">문제 원인 분석</h1><h2 id="1-response-분석">1. response 분석</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/2.png" alt="2.png" /></p><p>프론트엔드 도메인(<code class="language-plaintext highlighter-rouge">habitpay.link</code>)과 백엔드 도메인(<code class="language-plaintext highlighter-rouge">api.habitpay.link</code>)은 도메인이 다르기 때문에 브라우저는 CORS 정책을 확인하기 위해 OPTIONS 요청을 먼저 보냅니다. 하지만 백엔드에서는 <code class="language-plaintext highlighter-rouge">503 Service Unavailable</code> 응답을 반환했습니다.</p><h2 id="2-프론트엔드-코드-분석">2. 프론트엔드 코드 분석</h2><p>해당 API 요청은 게시물을 조회하는 API였고, 프론트엔드에서는 아래와 같이 API 요청을 보내고 있었습니다.</p><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// postItem.tsx</span>

<span class="kd">const</span> <span class="nx">PostItem</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">challengeId</span><span class="p">,</span> <span class="nx">contentDTO</span> <span class="p">}:</span> <span class="nx">PostsFeedProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 게시물 작성자에게만 수정 버튼을 보여주기 위한 state</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">isPostAuthor</span><span class="p">,</span> <span class="nx">setIsPostAuthor</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">getPostInfo</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">apiManager</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/posts/</span><span class="p">${</span><span class="nx">contentDTO</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="kd">const</span> <span class="na">data</span><span class="p">:</span> <span class="nx">ContentDTO</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="nx">setIsPostAuthor</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">isPostAuthor</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed to fetch post info:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">getPostInfo</span><span class="p">();</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">contentDTO</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>

  <span class="c1">// 하략</span>
<span class="p">};</span>
</pre></table></code></div></div><p>로컬 환경에서는 모든 OPTIONS 요청에 대해 아래의 이미지와 같이 정상적인 응답을 받았습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/3.png" alt="3.png" /></p><p>이를 통해 프론트엔드 코드 자체에는 문제가 없으며, 운영 서버에서만 발생하는 문제라고 판단했습니다.</p><p>로컬 환경과 운영 서버 환경의 유일한 차이는 nginx 사용 여부였으며, 각 환경을 그림으로 표현하면 아래와 같습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/4.png" alt="4.png" /></p><h2 id="3-nginx-설정-파일">3. nginx 설정 파일</h2><p>기존에 nginx 로그에서 <code class="language-plaintext highlighter-rouge">.env</code>, <code class="language-plaintext highlighter-rouge">.pem</code> 등의 파일을 탈취하려는 악의적인 요청이 다수 발생하는 것을 확인하고, 이러한 공격과 더불어 DDoS 공격을 방지하기 위해 nginx의 rate limit 기능을 추가한 적이 있었습니다.</p><p>nginx 설정 파일은 아래와 같았습니다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>limit_req_zone <span class="nv">$binary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span>ddos_limit:10m <span class="nv">rate</span><span class="o">=</span>10r/s<span class="p">;</span>

location / <span class="o">{</span>
    limit_req <span class="nv">zone</span><span class="o">=</span>ddos_limit <span class="nv">burst</span><span class="o">=</span>10 nodelay<span class="p">;</span>
    real_ip_header    X-Forwarded-For<span class="p">;</span>
    set_real_ip_from 0.0.0.0/0<span class="p">;</span>

    proxy_pass http://green<span class="p">;</span>
    proxy_http_version 1.1<span class="p">;</span>
    proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
    proxy_set_header Connection <span class="s1">'upgrade'</span><span class="p">;</span>
    proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
    proxy_cache_bypass <span class="nv">$http_upgrade</span><span class="p">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>nginx의 rate limit 기능은 DDoS 공격과 같이 짧은 시간에 과도하게 많은 요청을 보내는 공격을 방지하기 위해 사용하며, 설정 파일에서 이 기능을 사용하기 위한 부분은 아래와 같습니다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>limit_req_zone <span class="nv">$binary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span>ddos_limit:10m <span class="nv">rate</span><span class="o">=</span>10r/s<span class="p">;</span>
limit_req <span class="nv">zone</span><span class="o">=</span>ddos_limit <span class="nv">burst</span><span class="o">=</span>10 nodelay<span class="p">;</span>
</pre></table></code></div></div><h3 id="rate10rs">rate=10r/s</h3><p><code class="language-plaintext highlighter-rouge">rate=10r/s</code>는 동일한 IP에 대해 0.1초에 1개의 요청을 처리해서 1초에 총 10개 요청을 처리한다는 의미입니다. 만약, <code class="language-plaintext highlighter-rouge">rate=20r/s</code> 라면 0.05초에 1개의 요청을 처리해서 1초에 총 20개 요청을 처리한다는 의미입니다.</p><p><code class="language-plaintext highlighter-rouge">rate=10r/s</code> 일 때, 0.1초 안에 2개의 요청이 순차적으로 도착했다고 가정하겠습니다. 그러면 가장 먼저 도착한 요청은 처리하지만, 두 번째로 도착한 요청은 처리하지 않습니다.</p><h3 id="burst10">burst=10</h3><p><code class="language-plaintext highlighter-rouge">limit_req_zone</code>에서 명시한 rate보다 순간적으로 많은 트래픽이 들어오는 것을 허용하기 위해 사용합니다.</p><p><code class="language-plaintext highlighter-rouge">burst=10</code> 은 <code class="language-plaintext highlighter-rouge">rate=10r/s</code> 에서 0.1초에 1개의 요청을 허용하지만, 0.1초 안에 최대 10개 요청을 추가로 처리하겠다는 의미입니다. 예를 들어, 0.1초 안에 11개의 요청이 들어오면, 첫 요청은 처리하고, <code class="language-plaintext highlighter-rouge">burst=10</code> 옵션으로 인해 나머지 10개 요청은 크기가 10인 큐에 저장됩니다. 그리고 큐에 저장된 요청은 0.1초마다 pop해서 요청을 처리합니다. 하지만 마지막 요청은 큐의 모든 요청이 처리되고 나서 처리되기 때문에 1초 후에 응답을 받게 되며, 클라이언트 입장에서는 응답을 늦게 받는 단점이 있습니다.</p><h3 id="nodelay">nodelay</h3><p>이를 보완하기 위해 <code class="language-plaintext highlighter-rouge">nodelay</code> 옵션을 함께 사용할 수 있습니다. <code class="language-plaintext highlighter-rouge">rate=10r/s</code>, <code class="language-plaintext highlighter-rouge">burst=10</code> 인 상황에서 <code class="language-plaintext highlighter-rouge">nodelay</code> 옵션을 사용한 상황이라면, 0.1초 안에 11개의 요청이 들어와도 11개의 요청을 0.1초 안에 모두 처리해서 응답합니다. 다만, 첫 요청은 바로 처리하는 대신 나머지 10개의 요청은 큐에 넣습니다. 큐에 들어간 요청들은 <code class="language-plaintext highlighter-rouge">taken</code> 으로 마킹되어 들어가며, <code class="language-plaintext highlighter-rouge">nodelay</code> 옵션을 사용하지 않을 때와 동일하게 0.1초 간격으로 큐에서 pop 됩니다. 다만, pop 할 때 요청을 실제로 처리하지 않습니다. 만약, 0.1초 안에 12개의 요청이 오면 11개 요청은 처리되지만, 마지막 1개의 요청은 큐에 자리가 부족하기 때문에 처리할 수 없습니다.</p><p><code class="language-plaintext highlighter-rouge">nodelay</code> 옵션을 사용해도 0.1초 간격으로 큐에서 요청을 pop 하는 이유는 동일한 속도로 요청을 처리하는 것을 보장하기 위함입니다. 0.1초에 11개의 요청이 도착했다면 큐에는 10개의 요청이 들어가지만, 0.1초가 지나면 큐에 1자리가 생기며 이때 다른 요청 1개가 도착한다면 이 요청을 큐에 넣음과 동시에 요청을 처리합니다. 만약, 0.1초 뒤에 2개의 요청이 도착하면 첫 요청은 큐에 넣고, 다른 요청은 큐에 자리가 없으므로 처리할 수 없습니다.</p><h3 id="nginx-로그-확인">nginx 로그 확인</h3><p>nginx 공식 문서에 따르면 일정 시간 동안 처리할 수 요청 수 제한을 초과하면 503 오류를 반환한다고 나와있습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/5.png" alt="5.png" /></p><p>운영 서버에서 실패한 요청에 대해 nginx 로그를 확인해보니 아래와 같았습니다.</p><blockquote><p>2025/02/03 12:52:44 [error] 447#447: *3992 limiting requests, excess: 10.350 by zone “ddos_limit”, client: 218.50.111.206, server: api.habitpay.link, request: “OPTIONS /api/posts/69 HTTP/1.1”, host: “api.habitpay.link”, referrer: “https://habitpay.link/” 218.50.111.206 - - [03/Feb/2025:12:52:44 +0000] “OPTIONS /api/posts/69 HTTP/1.1” 503 599 “https://habitpay.link/” “Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36” “218.50.111.206”</p></blockquote><p><code class="language-plaintext highlighter-rouge">excess: 10.350 by zone "ddos_limit"</code>를 통해 큐의 크기(burst) 10을 초과한 10.350개가 들어왔고, 0.1초 안에 약 12개 요청이 들어왔다는 것을 알 수 있습니다.</p><p>운영 서버 페이지에서 발생한 오류와 nginx 오류를 비교해보니 동일한 것을 확인했습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/6.png" alt="6.png" /></p><h2 id="4-문제-원인-결론">4. 문제 원인 결론</h2><ul><li>프론트엔드의 <code class="language-plaintext highlighter-rouge">postsFeed</code> 컴포넌트에서 게시물 목록 조회 API(<code class="language-plaintext highlighter-rouge">api/challenges/[challengeId]/posts?size=10&amp;page=1</code>)는 한 번의 요청으로 10개의 게시물을 가져옵니다.<li>하지만 <code class="language-plaintext highlighter-rouge">postsFeed</code> 컴포넌트의 하위 컴포넌트인 <code class="language-plaintext highlighter-rouge">postItem</code> 컴포넌트에서 상위 컴포넌트에서 전달한 게시물 10개에 대해 중복된 게시물 조회 요청(<code class="language-plaintext highlighter-rouge">/api/posts/[postId]</code>)을 보냈습니다. 이때, OPTIONS 요청은 10개가 동시에 발생하는데, 페이지를 불러올 때 공지사항 조회, 챌린지 정보 조회와 같은 다른 API도 호출되었습니다.<li>nginx는 0.1초에 최대 11개 요청을 처리할 수 있지만, 12개 이상 요청이 nginx에 도착했기에 처리하지 못한 요청에 대해서는 503 오류를 반환했습니다.<li>그러다보니 <code class="language-plaintext highlighter-rouge">postItem</code> 컴포넌트 내부에서 게시물 조회 요청이 성공한 글의 <code class="language-plaintext highlighter-rouge">isPostAuthor</code> 상태는 <code class="language-plaintext highlighter-rouge">true</code>가 되었지만, 요청이 실패한 글의 상태는 초기값인 <code class="language-plaintext highlighter-rouge">false</code>로 유지되었습니다. 그래서 본인이 작성한 게시물 중에서도 일부만 게시물 수정 버튼이 보였고, 마치 간헐적으로 게시물 수정 버튼이 표시되는 것으로 보였던 것입니다.</ul><h1 id="문제-해결">문제 해결</h1><p><code class="language-plaintext highlighter-rouge">postItem</code> 컴포넌트에서 개별 게시물 조회 API 요청을 제거했습니다. 부모 컴포넌트인 <code class="language-plaintext highlighter-rouge">postsFeed</code>컴포넌트에서 게시물 10개에 대한 정보를 자식 컴포넌트인 <code class="language-plaintext highlighter-rouge">postItem</code>에 <code class="language-plaintext highlighter-rouge">contentDTO</code> props로 내려주기 때문에 <code class="language-plaintext highlighter-rouge">postItem</code> 컴포넌트에서 개별 게시물 조회 API를 요청할 필요가 없었습니다.</p><h1 id="결과물">결과물</h1><p>운영 서버에서도 정상적으로 본인이 작성한 게시물에 대해 수정 버튼이 표시되었습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2025/2025-02-09-nginx-rate-limit-503-error/7.png" alt="7.png" /></p><h1 id="교훈">교훈</h1><ol><li>로컬 개발 환경과 운영 서버 환경의 차이로 인해 사전에 문제를 발견하지 못했던 것이 가장 큰 원인이었습니다. 따라서 로컬 개발 환경을 운영 서버 환경과 최대한 동일하게 구성하는 것이 중요합니다.<li>nginx의 rate limit 설정을 적용할 때, 프론트엔드 요청 횟수를 고려해야 합니다.<li>불필요한 API 요청을 줄이면 성능 최적화와 함께 예상치 못한 오류를 방지할 수 있습니다.</ol><h1 id="참고자료">참고자료</h1><ul><li><a href="https://velog.io/@moonseok/NGINX-limitreq-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0">nginx로 악의적인 다수의 request 방지하기(limit_req)</a> [velog]<li><a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html">Module ngx_http_limit_req_module</a> [nginx]<li><a href="https://m.blog.naver.com/pjt3591oo/223219393491">[nginx] 요청 제한을 위한 ratelimit</a> [네이버 블로그]<li><a href="https://blog.nginx.org/blog/rate-limiting-nginx">Rate Limiting with NGINX</a> [nginx blog]</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/nginx/'>nginx</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정 - Dev Joon&url=https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[nginx] rate limit 설정으로 인한 503 Service Unavailable 오류 해결 과정 - Dev Joon&u=https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://han-joon-hyeok.github.io/posts/nginx-rate-limit-503-error/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Nest-js-google-typescript-style-with-eslint-and-prettier/">[Nest.js] 협업을 위한 Google TyepScript Style 을 ESLint, Prettier 에 간단하게 적용하기</a><li><a href="/posts/Next-js-google-typescript-style-with-eslint-and-prettier/">[Next.js] 협업을 위한 Google TyepScript Style 을 ESLint, Prettier 에 간단하게 적용하기</a><li><a href="/posts/ubuntu-file-write-permission-denied/">[Linux] 파일 write 작업 시 PermissionError: [Errno 13] Permission denied 오류 해결</a><li><a href="/posts/what-is-arp/">ARP 개념 정리</a><li><a href="/posts/ubuntu-python-crontab-not-working/">[Linux] python 을 crontab 으로 실행하도록 했는데 실행되지 않는 이유 (feat. 상대경로, 절대경로)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/programmers/">programmers</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/level2/">level2</a> <a class="post-tag" href="/tags/level1/">level1</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/pipex/">pipex</a> <a class="post-tag" href="/tags/born2beroot/">born2beroot</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/data-structure/">data structure</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/nginx-removing-nginx-version-from-response-header/"><div class="card-body"> <span class="timeago small" > Mar 27, 2025 <i class="unloaded">2025-03-27T00:10:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[nginx] response header의 Server 항목에서 nginx 버전 제거하기</h3><div class="text-muted small"><p> 개요 nginx의 응답 헤더(response header) 중 Server 항목에 nginx 버전 정보가 표시되지 않도록 설정하는 방법을 소개합니다. 문제 상황 nginx를 리버스 프록시로 사용하여 백엔드 API 요청을 처리하고 있었습니다. 우연히 클라이언트의 응답 헤더를 확인하던 중, 아래의 이미지와 같이 Server 항목에 nginx의 버전이...</p></div></div></a></div><div class="card"> <a href="/posts/forward-proxy-and-reverse-proxy/"><div class="card-body"> <span class="timeago small" > Apr 11, 2023 <i class="unloaded">2023-04-11T10:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Forward Proxy와 Reverse Proxy</h3><div class="text-muted small"><p> 프록시(Proxy)란? 프록시는 사전적인 의미로 ‘대리인’, ‘중개자’ 라는 의미를 가지고 있다. 컴퓨터 공학에서 프록시는 보안상의 문제로 직접 통신을 주고 받을 수 없는 두 PC 사이에서 통신을 중계하는 것을 의미한다. 이처럼 중계 기능을 수행하는 서버를 ‘프록시 서버’라고 한다. 출처: What is a Proxy Server? How ...</p></div></div></a></div><div class="card"> <a href="/posts/what-is-nginx/"><div class="card-body"> <span class="timeago small" > Apr 11, 2023 <i class="unloaded">2023-04-11T10:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>nginx란 무엇인가</h3><div class="text-muted small"><p> Nginx Nginx 는 웹 사이트의 서버(WAS)를 도와주는 비동기 이벤트 기반 구조의 경량화 웹 서버 프로그램이다. 클라이언트가 요청한 정적 파일을 응답하는 HTTP Web Server 로 활용하기도 하며, Reverse Proxy Server 로 활용하여 WAS 의 부하를 줄이는 로드 밸런서 역할을 하기도 한다. (참고: Forward Pro...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/intellij-java-spring-boot-does-not-exist-error/" class="btn btn-outline-primary" prompt="Older"><p>[Spring] IntelliJ java: package org.springframework.boot does not exist 오류 해결</p></a> <a href="/posts/difference-between-declarative-and-imperative/" class="btn btn-outline-primary" prompt="Newer"><p>선언형 프로그래밍(declarative programming)과 명령형 프로그래밍(imperative programming) 비교</p></a></div><script src="https://utteranc.es/client.js" repo="Han-Joon-Hyeok/Han-Joon-Hyeok.github.io" issue-term="pathname" label="Comments" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://github.com/han-joon-hyeok">Joon Hyeok Han</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/programmers/">programmers</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/level2/">level2</a> <a class="post-tag" href="/tags/level1/">level1</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/pipex/">pipex</a> <a class="post-tag" href="/tags/born2beroot/">born2beroot</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/data-structure/">data structure</a> <a class="post-tag" href="/tags/docker/">docker</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://han-joon-hyeok.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
