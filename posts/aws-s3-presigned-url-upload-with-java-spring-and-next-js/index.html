<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.0" /><meta property="og:title" content="[Spring/Next.js] AWS S3 Presigned URL 이용해서 이미지 업로드 및 조회 구현하기" /><meta name="author" content="Joon Hyeok Han" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="실행 환경" /><meta property="og:description" content="실행 환경" /><link rel="canonical" href="https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/" /><meta property="og:url" content="https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/" /><meta property="og:site_name" content="Dev Joon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-29T16:20:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Spring/Next.js] AWS S3 Presigned URL 이용해서 이미지 업로드 및 조회 구현하기" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Joon Hyeok Han" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joon Hyeok Han"},"dateModified":"2024-10-02T17:26:07+09:00","datePublished":"2024-05-29T16:20:00+09:00","description":"실행 환경","headline":"[Spring/Next.js] AWS S3 Presigned URL 이용해서 이미지 업로드 및 조회 구현하기","mainEntityOfPage":{"@type":"WebPage","@id":"https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/"},"url":"https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/"}</script><title>[Spring/Next.js] AWS S3 Presigned URL 이용해서 이미지 업로드 및 조회 구현하기 | Dev Joon</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SKST7KNWSJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SKST7KNWSJ'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dev Joon</a></div><div class="site-subtitle font-italic">성장하는 개발자, 한준혁입니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Han-Joon-Hyeok" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['joonhyeok.han','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>[Spring/Next.js] AWS S3 Presigned URL 이용해서 이미지 업로드 및 조회 구현하기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[Spring/Next.js] AWS S3 Presigned URL 이용해서 이미지 업로드 및 조회 구현하기</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, May 29, 2024, 4:20 PM +0900" > May 29, 2024 <i class="unloaded">2024-05-29T16:20:00+09:00</i> </span> by <span class="author"> Joon Hyeok Han </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Oct 2, 2024, 5:26 PM +0900" > Oct 2, 2024 <i class="unloaded">2024-10-02T17:26:07+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6350 words">35 min</span></div></div><div class="post-content"><h1 id="실행-환경">실행 환경</h1><ul><li>OS: MacOS Sonoma 14.5<li>Java: 17<li>Spring Boot: 3.2.3<li>Spring AWS S3: 3.0.0<li>Next.js: 14.0.4</ul><h1 id="개요">개요</h1><p>프론트는 Next.js, 백엔드는 Java Spring 을 이용한 웹 프로젝트에서 AWS S3 Presigned URL 을 이용한 이미지 업로드를 구현한 과정을 정리했다.</p><p>백엔드 서버의 디스크(AWS EBS 등)에 이미지를 저장할 수도 있지만, S3 를 이용하는 것이 훨씬 장점이 많았다.</p><p>특히 Presigned URL 을 이용하면 프론트에서 백엔드 서버로 이미지 파일을 보낸 다음, 백엔드에서 S3 에 업로드 하는 과정을 거치지 않고, 프론트에서 직접 S3 에 이미지를 업로드 할 수 있다.</p><p>즉, 백엔드는 프론트에 S3 에 이미지를 업로드 할 수 있는 임시 자격 권한을 위임한 것이다.</p><p>전체 과정을 요약해서 이미지로 표현하면 아래와 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/1.png" alt="1.png" /></p><h1 id="이미지-저장을-aws-s3-에-하는-이유">이미지 저장을 AWS S3 에 하는 이유</h1><p>구현에 앞서 이미지 파일을 AWS S3 에 저장하는 이유를 살펴보자.</p><p>AWS S3 를 선택한 이유는 크게 3가지로 정리할 수 있다.</p><h2 id="1-확장성">1. 확장성</h2><p>S3 를 이용하면 하드 디스크의 용량 제한 걱정 없이 이미지를 업로드 할 수 있다.</p><p>백엔드 서버는 EC2 인스턴스 에 실행하려고 하는데, 이미지 파일을 EC2 인스턴스에 연결된 EBS 볼륨(쉽게 생각하면 하드 디스크)에 저장한다면 용량이 부족할 때마다 용량을 확장 해주어야 한다.</p><p>용량을 확장하려면 직접 작업을 하는 건 어렵진 않지만, 꽤나 번거로운 작업이다.</p><p>이에 비해 S3 는 EBS 처럼 필요에 따라 용량을 늘리거나 줄일 필요가 없다.</p><p>사실상 S3 의 저장 공간은 사실상 무제한이라 생각하면 된다.</p><p>대신 S3 에는 실행 파일과 같은 바이너리 파일은 저장할 수 없고, 정적 파일(이미지, 동영상, HTML 등)을 업로드 하는 용도로 많이 사용한다.</p><h2 id="2-가격">2. 가격</h2><p>S3 는 EBS 에 비해 훨씬 저렴하다.</p><p>EBS 는 이미지 파일 뿐만 아니라 운영체제에 필요한 파일이나 라이브러리 파일들도 저장하기 때문에 가격이 높을 수 밖에 없다.</p><p>S3 와 EBS 의 저장 공간 요금 차이는 아래와 같다. (2024년 5월 기준)</p><div class="table-wrapper"><table><thead><tr><th>항목<th>가격(1GB)<th>가격(30GB)<tbody><tr><td>EBS<td>$0.114<td>$3<tr><td>S3<td>$0.025<td>$0.75</table></div><p>물론 S3 는 HTTP 요청(GET, PUT, DELETE) 빈도에 따라 요금이 추가로 부과되지만, EBS 를 사용하는 것에 비해 훨씬 저렴하다.</p><h2 id="3-백엔드-서버의-부담-줄이기">3. 백엔드 서버의 부담 줄이기</h2><p>S3 를 이용하면 이미지 저장을 처리하는 백엔드 서버의 부담을 줄일 수 있다.</p><p>만약 백엔드 서버에 이미지를 저장했다면 서버는 이미지도 저장하면서 동시에 다른 API 요청도 번갈아가면서 처리해야 한다.</p><p>이미지를 업로드 하는 사용자가 적으면 큰 문제가 없겠지만, 사용자가 많아진다면 하드 디스크에 파일 쓰기를 하느라 API 응답 속도도 느려질 것이다.</p><p>작은 규모로 만드는 프로젝트이기 때문에 백엔드 서버에 큰 부하가 있지는 않겠지만, 서비스가 커졌을 때 부하를 어떻게 관리할 것인지를 고려하면 S3 가 파일 저장만 담당하는 것이 괜찮은 선택이라 판단했다.</p><p>그래서 백엔드 서버는 비즈니스 로직만 담당하고, 파일 저장의 책임은 S3 가 나눠 갖도록 했다.</p><h1 id="presigned-url">Presigned URL</h1><p>Presigned URL 을 직역하면 ‘미리 서명된 URL’이다.</p><p>여기서 미리 서명되었다는 것의 의미는 ‘특정 자원에 접근할 수 있는 권한을 가진다는 것을 미리 인증했다는 것’을 의미한다.</p><p>Presigned URL 은 S3 뿐만 아니라 AWS 의 다른 서비스에서도 많이 쓰이는 개념이다.</p><p>Presigned URL 을 사용하는 이유는 프론트엔드에서 S3 버킷에 직접 파일을 업로드 할 수 있는 권한을 주기 위해서다.</p><p>Presigned URL 을 발급 받기 위해서는 AWS S3 버킷에 접근할 수 있다는 권한이 있어야 한다는 걸 증명해야 하는데, 이는 백엔드가 담당한다.</p><p>아무나 S3 버킷에 접근해서 파일을 업로드 하거나 파일을 읽으면 나의 소중한 돈이 새어 나가는 참사가 벌어지기 때문에 정해진 사람만 Presigned URL 을 이용해서 S3 에 접근할 수 있도록 제한을 걸어둔 것이다.</p><p>이미지 업로드 기능의 흐름은 아래와 같다.</p><ol><li>프론트엔드가 웹 브라우저에서 이미지 업로드<li>프론트엔드에서 백엔드로 이미지와 관련된 정보 전송(이미지 크기, 확장자, 파일 이름)<li>백엔드는 프론트엔드에서 보낸 정보를 바탕으로 AWS 로부터 Presigned URL 발급<li>백엔드는 발급 받은 Presigned URL 을 프론트엔드에 전달<li>프론트엔드는 4번에서 받은 링크로 PUT 메서드를 이용해서 이미지를 전송</ol><p>2번에서 이미지와 관련된 정보를 백엔드에 같이 보내는 이유는 프론트엔드에서 AWS S3 로 사용자가 마음대로 다른 파일을 업로드 하는 상황을 방지하기 위해서다.</p><p>백엔드가 AWS Presigned URL 을 발급 받을 때, 업로드 할 파일의 크기와 파일 확장자의 정보를 함께 보낼 수 있는데, 이 정보는 AWS S3 에서도 인식하고 있다.</p><p>그래서 S3 입장에서는 발급한 Presigned URL 로 업로드 요청이 들어왔을 때, Presigned URL 을 발급 했을 때 받은 파일의 크기와 다르거나, 파일의 확장자가 다르다면 업로드를 거부한다.</p><p>이를 통해 프론트엔드가 5MB 크기 이미지를 업로드 할 것처럼 백엔드에 요청해놓고, 1GB 크기 이미지를 S3 에 업로드 하는 일을 막을 수 있게 된다.</p><p>또한, Presigned URL 를 사용할 수 있는 유효 시간을 백엔드에서 정할 수 있기 때문에 아무 때나 S3 버킷에 파일을 업로드 하는 일을 막을 수도 있다.</p><p>이처럼 보안 측면에서도 이미지 업로드에 AWS S3 를 이용하면 장점이 있기 때문에 S3 를 이용해서 이미지 업로드 기능을 구현했다.</p><h1 id="aws-설정">AWS 설정</h1><h2 id="s3-버킷-생성">S3 버킷 생성</h2><p>Admin 권한이 있는 AWS 계정으로 접속한다.</p><p>S3 페이지로 이동해서 [버킷 만들기]를 클릭한다.</p><p>버킷 이름을 작성하고 나서 모든 옵션은 그대로 둔 채로 [버킷 만들기]를 클릭해서 버킷을 생성한다.</p><p>참고했던 자료에서는 퍼블릭 액세스 차단을 해제하도록 했는데, Presigned URL 을 이용하기 때문에 퍼블릭 액세스를 허용할 필요는 없다.</p><h2 id="cors-설정">CORS 설정</h2><p>버킷이 생성되면 해당 버킷으로 접속해서 [권한] 탭으로 이동한다.</p><p>맨 마지막에 CORS 항목을 [편집] 버튼을 클릭해서 아래와 같이 작성한다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="pi">[</span>
  <span class="pi">{</span>
    <span class="s2">"</span><span class="s">AllowedHeaders"</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">],</span>
    <span class="s2">"</span><span class="s">AllowedMethods"</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">HEAD"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">GET"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">PUT"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">POST"</span><span class="pi">],</span>
    <span class="s2">"</span><span class="s">AllowedOrigins"</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">],</span>
    <span class="s2">"</span><span class="s">ExposeHeaders"</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ETag"</span><span class="pi">],</span>
  <span class="pi">},</span>
<span class="pi">]</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/2.png" alt="2.png" /></p><h2 id="s3-전용-계정-생성">S3 전용 계정 생성</h2><p>백엔드에서 S3 에 접근하기 위한 계정을 하나 만들 것이다.</p><p>해당 계정은 S3 와 관련된 기능만 수행할 수 있도록 제한할 것이다.</p><p>IAM 서비스로 이동해서 [액세스 관리] - [사용자] 탭으로 들어간 후 [사용자 생성]을 클릭한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/3.png" alt="3.png" /></p><p>사용자 이름은 원하는 대로 작성한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/4.png" alt="4.png" /></p><p>[권한 옵션]에서 [직접 정책 연결]을 선택하고 <code class="language-plaintext highlighter-rouge">AmaazonS3FullAccess</code> 를 검색해서 선택한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/5.png" alt="5.png" /></p><p>마지막 페이지에서 [사용자 생성]을 클릭해서 사용자를 생성한다.</p><h2 id="액세스-키-발급">액세스 키 발급</h2><p>방금 생성한 계정을 통해 S3 에 접근하기 위해 액세스 키를 발급 받아야 한다.</p><p>[액세스 관리] - [사용자] 탭에서 방금 생성한 계정을 클릭해서 [보안 자격 증명] 탭으로 이동한다.</p><p>[액세스 키] 항목에서 [액세스 키 만들기]를 클릭한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/6.png" alt="6.png" /></p><p>[사용 사례] 페이지에서 [로컬 코드] 선택 후 하단에 체크박스를 선택하고 다음으로 넘어간다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/7.png" alt="7.png" /></p><p>두 번째 페이지는 태그 설정인데, 이 부분은 생략해도 된다.</p><p>[액세스 키 만들기] 버튼을 클릭하면 액세스 키가 발급된다.</p><p>발급 받은 비밀 액세스 키는 두 번 다시 볼 수 없기 때문에 반드시 별도로 저장한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/8.png" alt="8.png" /></p><h1 id="백엔드-구현">백엔드 구현</h1><h2 id="의존성-추가">의존성 추가</h2><p>AWS S3 를 백엔드에서 이용하기 위해 <code class="language-plaintext highlighter-rouge">build.gradle</code> 파일에 아래와 같이 의존성을 추가한다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">dependencies</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">implementation</span> <span class="s1">'io.awspring.cloud:spring-cloud-aws-starter-s3:3.0.0'</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>버전은 3.0.0 을 이용했는데, 시간이 지나면서 버전이 업데이트 되기 때문에 아래의 링크를 확인해서 최신 버전을 꼭 확인하자.</p><ul><li>https://spring.io/projects/spring-cloud-aws#learn</ul><p>Spring 에서 제공하는 AWS S3 공식 문서는 아래의 링크를 참고했다.</p><ul><li>https://docs.awspring.io/spring-cloud-aws/docs/3.0.0/reference/html/index.html#spring-cloud-aws-s3</ul><h2 id="aws-credentials-설정">AWS credentials 설정</h2><p>AWS SDK 를 이용하기 위해서 위에서 입력한 사용자 인증 정보(액세스 키, 시크릿 키)가 필요하다.</p><p><a href="https://docs.awspring.io/spring-cloud-aws/docs/3.0.0/reference/html/index.html#defaultcredentialsprovider">AWS 공식 문서</a>에 따르면 아래와 같은 순서로 인증 정보를 찾는다고 하는데, 3가지 정도만 정리했다.</p><ol><li><p>Java System Properties: <code class="language-plaintext highlighter-rouge">aws.accessKeyId</code> 와 <code class="language-plaintext highlighter-rouge">aws.secretAccessKey</code> 에 저장된 값을 불러온다.</p><ul><li>System Properties 를 설정하는 방법은 2가지가 있다.<li>첫 번째는 빌드한 애플리케이션을 실행할 때 설정하는 것이다.</ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>java <span class="nt">-Daws</span>.accessKeyId<span class="o">=</span>YOUR_ACCESS_KEY <span class="nt">-Daws</span>.secretAccessKey<span class="o">=</span>YOUR_SECRET_KEY <span class="nt">-Daws</span>.region.static<span class="o">=</span>ap-northeast-2 <span class="nt">-jar</span> yourapp.jar
</pre></table></code></div></div><ul><li>두 번째는 <code class="language-plaintext highlighter-rouge">System.setProperty()</code> 메서드를 이용하는 것이다. (참고자료: <a href="https://stackoverflow.com/questions/51867161/how-to-set-system-property-in-spring-boot-application">how to set system property in spring boot application</a> [stackoverflow]</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@Profile</span><span class="o">(</span><span class="s">"production"</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductionPropertySetter</span> <span class="o">{</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperty</span><span class="o">()</span> <span class="o">{</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"aws.accessKeyId"</span><span class="o">,</span> <span class="s">"..."</span><span class="o">);</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"aws.secretAccessKey"</span><span class="o">,</span> <span class="s">"..."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li>시스템 환경 변수: 로컬 환경에 환경 변수로 설정한 <code class="language-plaintext highlighter-rouge">AWS_ACCESS_KEY_ID</code> 와 <code class="language-plaintext highlighter-rouge">AWS_SECRET_ACCESS_KEY</code> 의 값을 불러온다.<li>Credentials Profiles: 로컬 환경의 <code class="language-plaintext highlighter-rouge">~/.aws/credentials</code> 파일은 AWS SDK 와 AWS CLI 에서 자격 증명을 저장하는데, 이 파일에 저장된 값을 불러온다.</ol><p>이 글에서는 위의 3가지 방법이 아닌 <code class="language-plaintext highlighter-rouge">application.yaml</code> 파일에 설정하는 방법을 소개하고자 한다.</p><h3 id="applicationyaml-파일-설정">application.yaml 파일 설정</h3><p><code class="language-plaintext highlighter-rouge">application.yaml</code> 파일에 AWS 계정과 관련한 정보를 입력한다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="na">spring</span><span class="pi">:</span>
<span class="err">	</span><span class="na">cloud</span><span class="pi">:</span>
<span class="err">	</span>  <span class="na">aws</span><span class="pi">:</span>
<span class="err">	</span>    <span class="na">s3</span><span class="pi">:</span>
<span class="err">	</span>      <span class="na">bucket</span><span class="pi">:</span> <span class="s">${BUCKET_NAME}</span>
<span class="na">	    stack</span><span class="pi">:</span>
<span class="err">	</span>      <span class="na">auto</span><span class="pi">:</span> <span class="no">false</span>
<span class="na">	    region</span><span class="pi">:</span>
<span class="err">	</span>      <span class="na">static</span><span class="pi">:</span> <span class="s">${AWS_REGION}</span>
<span class="na">	    credentials</span><span class="pi">:</span>
<span class="err">	</span>      <span class="na">access-key</span><span class="pi">:</span> <span class="s">${AWS_ACCESS_KEY}</span>
<span class="na">	      secret-key</span><span class="pi">:</span> <span class="s">${AWS_SECRET_KEY}</span>
</pre></table></code></div></div><p>속성에 대한 설명은 아래와 같다.</p><ul><li>cloud.aws.s3.bucket: 저장에 사용할 S3 버킷 이름<li>cloud.aws.stack.auto: AWS CloudFormation 의 Stack 에 연동을 자동으로 할 것인지 결정<ul><li>정확한 의미는 잘 모르겠지만, 사용하지 않을 것이므로 <code class="language-plaintext highlighter-rouge">false</code> 로 설정 (<a href="https://docs.awspring.io/spring-cloud-aws/docs/current/reference/html/index.html#cloudformation-configuration-in-spring-boot">공식문서 링크</a>)</ul><li>cloud.aws.region.static: AWS 서비스를 사용한 리전 이름<li>cloud.aws.credentials.access-key, secret-key: AWS IAM 에서 발급한 액세스 키와 시크릿 키</ul><p><code class="language-plaintext highlighter-rouge">${KEY}</code> 형태로 입력한 것들은 <code class="language-plaintext highlighter-rouge">.env</code> 파일에 저장한 값들을 가져오기 위한 것이다.</p><p><code class="language-plaintext highlighter-rouge">.env</code> 파일에 위에서 발급 받은 IAM 사용자의 액세스 키와 시크릿 키 값을 입력한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>BUCKET_NAME="my-bucket"
AWS_REGION="ap-northeast-2"
AWS_ACCESS_KEY="AKIAT3UTX3E2CSZBAYRH"
AWS_SECRET_KEY="my-secret"
</pre></table></code></div></div><p>IntelliJ 의 <code class="language-plaintext highlighter-rouge">EnvFile</code> 이라는 플러그인을 별도로 설치해서 환경변수 파일을 불러오고 있다.</p><p>해당 플러그인 설치 및 사용법은 아래의 링크를 참고하자.</p><ul><li>https://github.com/Ashald/EnvFile</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2024/2024-05-29-aws-s3-presigned-url-upload-with-java-spring-and-next-js/9.png" alt="9.png" /></p><p>AWS 서비스를 이용하기 위한 속성에 대한 자세한 정보는 아래의 링크를 참고했다. (3.0.0 버전 기준)</p><ul><li>https://docs.awspring.io/spring-cloud-aws/docs/3.0.0/reference/html/appendix.html</ul><h2 id="s3-서비스-코드-작성">S3 서비스 코드 작성</h2><h3 id="s3fileservicejava">S3FileService.java</h3><p>S3 와 관련한 비즈니스 로직을 처리하는 클래스인 <code class="language-plaintext highlighter-rouge">S3FileService</code> 를 생성했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S3FileService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">S3Client</span> <span class="n">s3Client</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">S3Presigner</span> <span class="n">presigner</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.cloud.aws.s3.bucket}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">bucket</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">@Service</code> 어노테이션을 사용해서 Bean 객체로 등록한다.<li><code class="language-plaintext highlighter-rouge">@RequiredArgsConstructor</code> 를 통해 final 멤버 변수로 등록한 <code class="language-plaintext highlighter-rouge">S3Client</code> 와 <code class="language-plaintext highlighter-rouge">S3Presigner</code> 객체를 Spring 컨테이너로부터 주입받는다.<li><code class="language-plaintext highlighter-rouge">spring.cloud.aws.s3.bucket</code> 은 공식적으로 지원하는 속성이 아니기 때문에 <code class="language-plaintext highlighter-rouge">@Value</code> 어노테이션을 통해 값을 가져오도록 했다.</ul><h3 id="http-put-요청-presigned-url-발급">HTTP PUT 요청 Presigned URL 발급</h3><p>S3 에 파일을 업로드 할 때는 POST 가 아닌 PUT 메서드를 사용한다.</p><p>이는 S3 가 동일한 이름을 가진 파일의 버전 관리를 지원하기 때문이다.</p><p>앞에서 생성한 <code class="language-plaintext highlighter-rouge">S3FileService</code> 클래스에 S3 에 HTTP PUT 요청을 보낼 수 있는 Presigned URL 을 받는 메서드를 작성했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPutPreSignedUrl</span><span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">extension</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">contentLength</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s/%s"</span><span class="o">,</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">contentType</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"image/%s"</span><span class="o">,</span> <span class="n">extension</span><span class="o">);</span>
    <span class="nc">PutObjectRequest</span> <span class="n">objectRequest</span> <span class="o">=</span> <span class="nc">PutObjectRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="n">bucket</span><span class="o">)</span>
            <span class="o">.</span><span class="na">key</span><span class="o">(</span><span class="n">filePath</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">contentType</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentLength</span><span class="o">(</span><span class="n">contentLength</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="nc">PutObjectPresignRequest</span> <span class="n">presignRequest</span> <span class="o">=</span> <span class="nc">PutObjectPresignRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">signatureDuration</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMinutes</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
            <span class="o">.</span><span class="na">putObjectRequest</span><span class="o">(</span><span class="n">objectRequest</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="nc">PresignedPutObjectRequest</span> <span class="n">presignedRequest</span> <span class="o">=</span> <span class="n">presigner</span><span class="o">.</span><span class="na">presignPutObject</span><span class="o">(</span><span class="n">presignRequest</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[S3FileService] getPutPreSignedUrl: {}"</span><span class="o">,</span> <span class="n">presignedRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">presignedRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>S3 버킷에 폴더가 존재하지 않더라도 폴더도 파일이기 때문에 PUT 요청을 보내면 새롭게 폴더가 생성된다.</p><p>주목할 부분은 <code class="language-plaintext highlighter-rouge">PutObjectRequest</code> 객체를 생성할 때 <code class="language-plaintext highlighter-rouge">contentType</code> 과 <code class="language-plaintext highlighter-rouge">contentLength</code> 를 매개변수로 받는다는 점이다.</p><p>만약 이 정보들이 없다면 프론트에서는 마음대로 용량이 지나치게 큰 파일이나, 사진이 아닌 동영상을 올릴 가능성이 있다.</p><p>그래서 프론트는 이미지 파일의 확장자와 이미지 파일의 크기를 백엔드로 전송하고, 백엔드는 이 정보를 바탕으로 AWS 에 Presigned URL 을 요청하도록 했다.</p><p>프론트는 백엔드에서 받은 Presigned URL 를 이용해서 이미지 파일을 전송하는데, 이때 백엔드에서 AWS 에 Presigned URL 을 발급 받을 때 입력했던 정보인 <code class="language-plaintext highlighter-rouge">contentType</code> 과 <code class="language-plaintext highlighter-rouge">contentLength</code> 와 프론트에서 보내는 <code class="language-plaintext highlighter-rouge">contentType</code> 과 <code class="language-plaintext highlighter-rouge">contentLength</code> 정보가 다르다면 업로드를 거절한다.</p><p>그리고 발급 받은 Presigned URL 의 유효시간을 짧게 설정함으로써 링크가 탈취당한 경우에는 업로드 시도를 최소화하고, 의도적으로 다른 파일을 올리려고 시도하는 경우도 최소화하고자 했다.</p><h3 id="http-get-요청-presigned-url-발급">HTTP GET 요청 Presigned URL 발급</h3><p>S3 에 저장한 이미지 파일의 이름은 사용자 정보와 함께 DB 에 저장했다.</p><p>이미지 파일을 아무나 받아가게 하는 것은 비용의 증가로 이어지기 때문에 S3 버킷에 저장한 이미지를 불러올 때도 Presigned URL 을 이용해서 받아오도록 했다.</p><p>아래의 메서드도 <code class="language-plaintext highlighter-rouge">S3FileService</code> 클래스에 정의했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">String</span> <span class="nf">getGetPreSignedUrl</span><span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s/%s"</span><span class="o">,</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
    <span class="nc">GetObjectRequest</span> <span class="n">objectRequest</span> <span class="o">=</span> <span class="nc">GetObjectRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="n">bucket</span><span class="o">)</span>
            <span class="o">.</span><span class="na">key</span><span class="o">(</span><span class="n">filePath</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="nc">GetObjectPresignRequest</span> <span class="n">presignRequest</span> <span class="o">=</span> <span class="nc">GetObjectPresignRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">signatureDuration</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMinutes</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
            <span class="o">.</span><span class="na">getObjectRequest</span><span class="o">(</span><span class="n">objectRequest</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="nc">PresignedGetObjectRequest</span> <span class="n">presignedRequest</span> <span class="o">=</span> <span class="n">presigner</span><span class="o">.</span><span class="na">presignGetObject</span><span class="o">(</span><span class="n">presignRequest</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[S3FileService] getGetPreSignedUrl: {}"</span><span class="o">,</span> <span class="n">presignedRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">presignedRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">toExternalForm</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="컨트롤러-작성">컨트롤러 작성</h2><h3 id="이미지-업로드-컨트롤러">이미지 업로드 컨트롤러</h3><p>프론트가 보낸 이미지 업로드 요청을 받는 컨트롤러에서는 이미지 파일 확장자와 이미지 파일의 크기를 받도록 아래의 DTO 클래스를 만들었다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// domain/member/dto/MemberRequest.java</span>

<span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRequest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">imageExtension</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">contentLength</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>컨트롤러를 담당하는 API 클래스에는 <code class="language-plaintext highlighter-rouge">S3FileService</code> 클래스의 의존성을 주입한다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// domain/member/api/MemberApi.java</span>

<span class="nd">@RestController</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberApi</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberProfileService</span> <span class="n">memberProfileService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">S3FileService</span> <span class="n">s3FileService</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Authorization Header 에 담긴 JWT 토큰의 정보를 기반으로 사용자의 정보를 찾고, 이미지 파일과 관련한 예외처리를 추가해서 아래와 같이 컨트롤러를 작성했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre><span class="c1">// domain/member/api/MemberApi.java</span>

<span class="nd">@PatchMapping</span><span class="o">(</span><span class="s">"/member"</span><span class="o">)</span>
<span class="nd">@ResponseStatus</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">patchMember</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">,</span>
                                          <span class="nd">@RequestHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">authorizationHeader</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">optionalToken</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getTokenFromHeader</span><span class="o">(</span><span class="n">authorizationHeader</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">optionalToken</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">ErrorResponse</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span> <span class="n">nickname</span> <span class="o">=</span> <span class="n">memberRequest</span><span class="o">.</span><span class="na">getNickname</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">imageExtension</span> <span class="o">=</span> <span class="n">memberRequest</span><span class="o">.</span><span class="na">getImageExtension</span><span class="o">();</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[PATCH /member] nickname: {}, imageExtension: {}"</span><span class="o">,</span> <span class="n">nickname</span><span class="o">,</span> <span class="n">imageExtension</span><span class="o">);</span>

    <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">optionalToken</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="nc">Long</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">memberRequest</span><span class="o">.</span><span class="na">getContentLength</span><span class="o">();</span>

    <span class="c1">// 1. 이미지 크기 제한이 넘을 경우</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ImageUtil</span><span class="o">.</span><span class="na">isValidFileSize</span><span class="o">(</span><span class="n">contentLength</span><span class="o">)</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">ErrorResponse</span><span class="o">.</span><span class="na">IMAGE_CONTENT_TOO_LARGE</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">PAYLOAD_TOO_LARGE</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 2. 이미지 확장자가 허용되지 않은 경우</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ImageUtil</span><span class="o">.</span><span class="na">isValidImageExtension</span><span class="o">(</span><span class="n">imageExtension</span><span class="o">)</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">ErrorResponse</span><span class="o">.</span><span class="na">UNSUPPORTED_IMAGE_EXTENSION</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNSUPPORTED_MEDIA_TYPE</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 3. 닉네임 규칙이 맞지 않은 경우</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">memberProfileService</span><span class="o">.</span><span class="na">isValidNickname</span><span class="o">(</span><span class="n">nickname</span><span class="o">)</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">ErrorResponse</span><span class="o">.</span><span class="na">INVALID_NICKNAME_RULE</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNPROCESSABLE_ENTITY</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 4. 닉네임만 변경</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">imageExtension</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">member</span><span class="o">.</span><span class="na">updateProfile</span><span class="o">(</span><span class="n">nickname</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getImageFileName</span><span class="o">());</span>
        <span class="n">memberService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">Response</span><span class="o">.</span><span class="na">PROFILE_UPDATE_SUCCESS</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 5. 프로필 이미지가 이미 존재하고, 새롭게 업로드 하는 경우</span>
    <span class="n">s3FileService</span><span class="o">.</span><span class="na">deleteImage</span><span class="o">(</span><span class="s">"profiles"</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getImageFileName</span><span class="o">());</span>

    <span class="nc">String</span> <span class="n">randomFileName</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">savedFileName</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s.%s"</span><span class="o">,</span> <span class="n">randomFileName</span><span class="o">,</span> <span class="n">imageExtension</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[PATCH /member] savedFileName: {}"</span><span class="o">,</span> <span class="n">savedFileName</span><span class="o">);</span>

    <span class="n">member</span><span class="o">.</span><span class="na">updateProfile</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getNickname</span><span class="o">(),</span> <span class="n">savedFileName</span><span class="o">);</span>
    <span class="n">memberService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>

    <span class="nc">String</span> <span class="n">preSignedUrl</span> <span class="o">=</span> <span class="n">s3FileService</span><span class="o">.</span><span class="na">getPutPreSignedUrl</span><span class="o">(</span><span class="s">"profiles"</span><span class="o">,</span> <span class="n">savedFileName</span><span class="o">,</span> <span class="n">imageExtension</span><span class="o">,</span> <span class="n">contentLength</span><span class="o">);</span>

    <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">preSignedUrl</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="이미지-get-컨트롤러">이미지 GET 컨트롤러</h3><p>사용자 정보를 조회하면서 사용자가 업로드한 이미지 링크를 받아오기 위한 컨트롤러는 아래와 같이 작성했다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="c1">// domain/member/api/MemberApi.java</span>

<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/member"</span><span class="o">)</span>
<span class="nd">@ResponseStatus</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;?&gt;</span> <span class="n">getMember</span><span class="o">(</span><span class="nd">@RequestHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">authorizationHeader</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">optionalToken</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getTokenFromHeader</span><span class="o">(</span><span class="n">authorizationHeader</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">optionalToken</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">ErrorResponse</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">optionalToken</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[GET /member] token: {}"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>

    <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[GET /member] email: {}"</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>

    <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">nickname</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getNickname</span><span class="o">();</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">optionalImageFileName</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getImageFileName</span><span class="o">());</span>
    <span class="nc">MemberResponse</span> <span class="n">memberResponse</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">optionalImageFileName</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">memberResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberResponse</span><span class="o">(</span><span class="n">nickname</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">imageFileName</span> <span class="o">=</span> <span class="n">optionalImageFileName</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[GET /member] imageFileName: {}"</span><span class="o">,</span> <span class="n">imageFileName</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">preSignedGetUrl</span> <span class="o">=</span> <span class="n">s3FileService</span><span class="o">.</span><span class="na">getGetPreSignedUrl</span><span class="o">(</span><span class="s">"profiles"</span><span class="o">,</span> <span class="n">imageFileName</span><span class="o">);</span>
        <span class="n">memberResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberResponse</span><span class="o">(</span><span class="n">nickname</span><span class="o">,</span> <span class="n">preSignedGetUrl</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="n">memberResponse</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">MemberResponse</code> DTO 는 아래와 같다.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// domain/member/dto/MemberApi.java</span>

<span class="nd">@Getter</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberResponse</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">imageUrl</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h1 id="프론트-구현">프론트 구현</h1><h2 id="이미지-업로드">이미지 업로드</h2><p>프론트는 이미지를 업로드 하기 위해 백엔드에 S3 에 이미지를 저장할 수 있는Presigned URL 을 받아야 한다.</p><p>그리고 이 링크를 통해 S3 에 이미지를 업로드한다.</p><p>이미지와 닉네임을 입력받기 때문에 <a href="https://react-hook-form.com/">react-hook-form</a> 라이브러리를 이용해서 form 의 유효성 검증을 처리했다.</p><h3 id="form-인터페이스">form 인터페이스</h3><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">IForm</span> <span class="p">{</span>
  <span class="nl">nickname</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">profileImage</span><span class="p">:</span> <span class="nx">FileList</span> <span class="o">|</span> <span class="nx">File</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>form 에서 input 태그를 통해 이미지 파일을 받기 때문에 <code class="language-plaintext highlighter-rouge">FileList</code> 나 <code class="language-plaintext highlighter-rouge">File</code> 자료형을 받을 수 있도록 인터페이스를 정의했다.</p><h3 id="dto-인터페이스">DTO 인터페이스</h3><p>백엔드로 전송할 데이터는 이미지 바이너리 파일이 아닌 이미지의 메타데이터에 해당하는 이미지 확장자와 이미지 파일 크기이다.</p><p>그래서 아래와 같이 인터페이스를 정의했다.</p><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">IProfileDTO</span> <span class="p">{</span>
  <span class="nl">nickname</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">imageExtension</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">contentLength</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="put-요청-presigned-url-요청">PUT 요청 Presigned URL 요청</h3><p>백엔드에 S3 에 업로드 할 수 있는 Presigned URL 을 요청하기 위해 아래와 같은 코드를 작성했다.</p><p>백엔드에는 <code class="language-plaintext highlighter-rouge">IForm</code> 인터페이스가 아닌 <code class="language-plaintext highlighter-rouge">IProfileDTO</code> 로 보내야 하기 때문에 <code class="language-plaintext highlighter-rouge">IForm</code> 에 담긴 정보를 <code class="language-plaintext highlighter-rouge">IProfileDTO</code> 로 옮긴 다음 백엔드로 API 요청을 보낸다.</p><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">onSubmitWithValid</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">validForm</span><span class="p">:</span> <span class="nx">IForm</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="na">data</span><span class="p">:</span> <span class="nx">IProfileDTO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">nickname</span><span class="p">:</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">nickname</span> <span class="p">?</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">nickname</span> <span class="p">:</span> <span class="nx">nickname</span><span class="p">,</span>
    <span class="na">imageExtension</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
    <span class="na">contentLength</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span> <span class="k">instanceof</span> <span class="nx">FileList</span> <span class="o">&amp;&amp;</span>
    <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span> <span class="o">=</span> <span class="nx">file</span><span class="p">;</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">imageExtension</span> <span class="o">=</span> <span class="nx">imageExtension</span><span class="p">;</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">contentLength</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// PUT 요청 Presigend URL 요청</span>
    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">apiManager</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/member</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div><h3 id="s3-이미지-업로드">S3 이미지 업로드</h3><p>백엔드에서 Presigned URL 을 발급 받으면 이 링크를 통해 S3 로 이미지 파일을 보내기만 하면 끝난다.</p><p>백엔드에서 <code class="language-plaintext highlighter-rouge">Content-Type</code> 과 <code class="language-plaintext highlighter-rouge">Content-Length</code> 를 검증하도록 설정해놨기 때문에 header 에 <code class="language-plaintext highlighter-rouge">Content-Type</code> 만 추가해서 보내주기만 하면 된다.</p><p><code class="language-plaintext highlighter-rouge">Content-Length</code> 는 자동으로 계산되어 header 에 추가된다.</p><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">try</span> <span class="p">{</span>
  <span class="c1">// PUT 요청 Presigend URL 요청</span>
  <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">apiManager</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/member</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>

	<span class="c1">// Presigned URL 를 이용해서 S3 에 이미지 업로드</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">HttpStatusCode</span><span class="p">.</span><span class="nx">Ok</span> <span class="o">&amp;&amp;</span> <span class="nx">previewImage</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="na">preSignedUrl</span><span class="p">:</span> <span class="kr">string</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">res2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">preSignedUrl</span><span class="p">,</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">,</span> <span class="p">{</span>
		  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
		    <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">image/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">imageExtension</span><span class="p">,</span>
		  <span class="p">},</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="이미지-조회-요청">이미지 조회 요청</h2><p>이미지를 받아오는 과정은 백엔드에서 알아서 가져오기 때문에 프론트에서는 백엔드로 요청을 보내기만 하면 된다.</p><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">getProfile</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">apiManager</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/member</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">nickname</span><span class="p">,</span> <span class="nx">imageUrl</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">nickname</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="nl">imageUrl</span><span class="p">:</span> <span class="kr">string</span> <span class="p">}</span> <span class="o">=</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">imageUrl</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setProfileImageUrl</span><span class="p">(</span><span class="nx">imageUrl</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">setNickname</span><span class="p">(</span><span class="nx">nickname</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div><h2 id="전체-코드">전체 코드</h2><p>코드에는 이미지 업로드 후 이미지 미리보기 기능도 함께 구현되어있다.</p><div class="language-tsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
</pre><td class="rouge-code"><pre><span class="dl">"</span><span class="s2">use client</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">useEffect</span><span class="p">,</span> <span class="nx">useState</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Image</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next/image</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">useForm</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-hook-form</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">axios</span><span class="p">,</span> <span class="p">{</span> <span class="nx">HttpStatusCode</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">axios</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">Layout</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@app/components/layout</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Button</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@app/components/button</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">profilePic</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@public/default-profile.jpeg</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">apiManager</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@api/apiManager</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">removeJwtFromSessionStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@libs/jwt</span><span class="dl">"</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">IForm</span> <span class="p">{</span>
  <span class="nl">nickname</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">profileImage</span><span class="p">:</span> <span class="nx">FileList</span> <span class="o">|</span> <span class="nx">File</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IProfileDTO</span> <span class="p">{</span>
  <span class="nl">nickname</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">imageExtension</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">contentLength</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">MB</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span>
    <span class="nx">register</span><span class="p">,</span>
    <span class="nx">setError</span><span class="p">,</span>
    <span class="nx">handleSubmit</span><span class="p">,</span>
    <span class="na">formState</span><span class="p">:</span> <span class="p">{</span> <span class="nx">errors</span> <span class="p">},</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">useForm</span><span class="o">&lt;</span><span class="nx">IForm</span><span class="o">&gt;</span><span class="p">({});</span>

  <span class="kd">const</span> <span class="p">[</span><span class="nx">nickname</span><span class="p">,</span> <span class="nx">setNickname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">imageExtension</span><span class="p">,</span> <span class="nx">setImageExtension</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">profileImageUrl</span><span class="p">,</span> <span class="nx">setProfileImageUrl</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">string</span> <span class="o">|</span> <span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">previewImage</span><span class="p">,</span> <span class="nx">setPreviewImage</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">string</span> <span class="o">|</span> <span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">onSubmitWithValid</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="na">validForm</span><span class="p">:</span> <span class="nx">IForm</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="na">data</span><span class="p">:</span> <span class="nx">IProfileDTO</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">nickname</span><span class="p">:</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">nickname</span> <span class="p">?</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">nickname</span> <span class="p">:</span> <span class="nx">nickname</span><span class="p">,</span>
      <span class="na">imageExtension</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
      <span class="na">contentLength</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span> <span class="k">instanceof</span> <span class="nx">FileList</span> <span class="o">&amp;&amp;</span>
      <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span> <span class="o">=</span> <span class="nx">file</span><span class="p">;</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">imageExtension</span> <span class="o">=</span> <span class="nx">imageExtension</span><span class="p">;</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">contentLength</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">validForm</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">apiManager</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/member</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">HttpStatusCode</span><span class="p">.</span><span class="nx">Ok</span> <span class="o">&amp;&amp;</span> <span class="nx">previewImage</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="na">preSignedUrl</span><span class="p">:</span> <span class="kr">string</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">res2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">preSignedUrl</span><span class="p">,</span> <span class="nx">validForm</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">image/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">imageExtension</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res2</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">onProfileNicknameChange</span> <span class="o">=</span> <span class="p">(</span>
    <span class="na">event</span><span class="p">:</span> <span class="nx">React</span><span class="p">.</span><span class="nx">ChangeEvent</span><span class="o">&lt;</span><span class="nx">HTMLInputElement</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setNickname</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">onProfileImageChange</span> <span class="o">=</span> <span class="p">(</span><span class="na">event</span><span class="p">:</span> <span class="nx">React</span><span class="p">.</span><span class="nx">ChangeEvent</span><span class="o">&lt;</span><span class="nx">HTMLInputElement</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">files</span> <span class="o">||</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">const</span> <span class="nx">fileType</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="kd">type</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">validExtensions</span> <span class="o">=</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">image/jpeg</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">image/jpg</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">image/png</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">image/gif</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validExtensions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">fileType</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">setError</span><span class="p">(</span><span class="dl">"</span><span class="s2">profileImage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">지원되는 파일 형식은 JPEG, JPG, PNG, GIF입니다.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">MB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setError</span><span class="p">(</span><span class="dl">"</span><span class="s2">profileImage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">파일 크기는 1MB를 초과할 수 없습니다.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">setError</span><span class="p">(</span><span class="dl">"</span><span class="s2">profileImage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">""</span> <span class="p">});</span>

      <span class="kd">const</span> <span class="na">extension</span><span class="p">:</span> <span class="kr">string</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="kd">type</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="kd">type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">setImageExtension</span><span class="p">(</span><span class="nx">extension</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
      <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">setPreviewImage</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">result</span> <span class="k">as</span> <span class="kr">string</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">getProfile</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">apiManager</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/member</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">nickname</span><span class="p">,</span> <span class="nx">imageUrl</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">nickname</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="nl">imageUrl</span><span class="p">:</span> <span class="kr">string</span> <span class="p">}</span> <span class="o">=</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">imageUrl</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setProfileImageUrl</span><span class="p">(</span><span class="nx">imageUrl</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">setNickname</span><span class="p">(</span><span class="nx">nickname</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">getProfile</span><span class="p">();</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">Layout</span> <span class="na">title</span><span class="p">=</span><span class="s">"프로필"</span> <span class="na">hasTabBar</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="p">=</span><span class="s">"flex flex-col items-center space-y-10"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span>
          <span class="na">className</span><span class="p">=</span><span class="s">"static flex flex-col items-center w-full px-4 space-y-4"</span>
          <span class="na">onSubmit</span><span class="p">=</span><span class="si">{</span><span class="nx">handleSubmit</span><span class="p">(</span><span class="nx">onSubmitWithValid</span><span class="p">)</span><span class="si">}</span>
        <span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nc">Image</span>
            <span class="na">className</span><span class="p">=</span><span class="s">"rounded-full size-32"</span>
            <span class="na">src</span><span class="p">=</span><span class="si">{</span><span class="nx">previewImage</span> <span class="o">||</span> <span class="nx">profileImageUrl</span> <span class="o">||</span> <span class="nx">profilePic</span><span class="si">}</span>
            <span class="na">alt</span><span class="p">=</span><span class="s">"Picture of me"</span>
            <span class="na">width</span><span class="p">=</span><span class="si">{</span><span class="mi">300</span><span class="si">}</span>
            <span class="na">height</span><span class="p">=</span><span class="si">{</span><span class="mi">300</span><span class="si">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">label</span> <span class="na">className</span><span class="p">=</span><span class="s">"absolute inline-flex items-center justify-center w-6 h-6 text-sm font-semibold text-gray-600 bg-gray-100 rounded-full top-40 left-64 me-2"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span>
              <span class="na">className</span><span class="p">=</span><span class="s">"hidden"</span>
              <span class="na">type</span><span class="p">=</span><span class="s">"file"</span>
              <span class="na">accept</span><span class="p">=</span><span class="s">"image/jpeg, image/jpg, image/png, image/gif"</span>
              <span class="si">{</span><span class="p">...</span><span class="nx">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">profileImage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">onChange</span><span class="p">:</span> <span class="nx">onProfileImageChange</span> <span class="p">})</span><span class="si">}</span>
            <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="p">=</span><span class="s">"flex flex-col w-full space-y-6"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="p">=</span><span class="s">"flex flex-col w-full space-y-2"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="p">=</span><span class="s">"text-sm"</span><span class="p">&gt;</span>닉네임<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">input</span>
                <span class="na">type</span><span class="p">=</span><span class="s">"text"</span>
                <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">nickname</span><span class="si">}</span>
                <span class="si">{</span><span class="p">...</span><span class="nx">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">nickname</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">onChange</span><span class="p">:</span> <span class="nx">onProfileNicknameChange</span> <span class="p">})</span><span class="si">}</span>
                <span class="na">className</span><span class="p">=</span><span class="s">"w-full px-3 py-2 placeholder-gray-400 appearance-none rounded-2xl focus:outline-none focus:ring-green-500 focus:border-green-500"</span>
              <span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nc">Button</span> <span class="na">text</span><span class="p">=</span><span class="s">"저장"</span> <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="nx">errors</span><span class="p">.</span><span class="nx">nickname</span> <span class="o">&amp;&amp;</span> <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">errors</span><span class="p">.</span><span class="nx">nickname</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span><span class="si">}</span>
          <span class="si">{</span><span class="nx">errors</span><span class="p">.</span><span class="nx">profileImage</span> <span class="o">&amp;&amp;</span> <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">errors</span><span class="p">.</span><span class="nx">profileImage</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="err">/</span><span class="na">Layout</span><span class="p">&gt;</span>
  );
};

export default Page;

</pre></table></code></div></div><h1 id="참고자료">참고자료</h1><ul><li><a href="https://vanillacreamdonut.tistory.com/365">[Springboot] AWS S3 버킷을 이용한 PresignedUrl로 이미지 업로드 구현하기</a> [티스토리]<li><a href="https://velog.io/@jmjmjmz732002/Spring-Boot-%EC%84%9C%EB%B2%84%EB%A6%AC%EC%8A%A4-%EA%B8%B0%EB%B0%98-S3-Presigned-URL-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0">[Spring Boot] 서버리스 기반 S3 Presigned URL 적용하기</a> [velog]<li><a href="https://velog.io/@mingsound21/SpringBoot-AWS-S3%EB%A1%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%97%85%EB%A1%9C%EB%93%9C">[SpringBoot] AWS S3로 이미지 업로드</a> [velog]<li><a href="https://velog.io/@invidam/S3-Presigned-Url-%EB%8F%84%EC%9E%85%ED%95%98%EA%B8%B0">S3 Presigned Url 도입하기 (+Java로 파일 크기 제한[content-length] 추가)</a> [velog]<li><a href="https://white-developer.tistory.com/75">Spring boot 3.0 + S3 서비스 적용 By Spring Cloud for AWS</a> [티스토리]<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/example_s3_Scenario_PresignedUrl_section.html">Create a presigned URL for Amazon S3 using an AWS SDK</a> [aws docs]</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/spring/'>Spring</a>, <a href='/categories/typescript/'>TypeScript</a>, <a href='/categories/nextjs/'>Nextjs</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Spring/Next.js] AWS S3 Presigned https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/ 이용해서 이미지 업로드 및 조회 구현하기 - Dev Joon&url=https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Spring/Next.js] AWS S3 Presigned https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/ 이용해서 이미지 업로드 및 조회 구현하기 - Dev Joon&u=https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[Spring/Next.js] AWS S3 Presigned https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/ 이용해서 이미지 업로드 및 조회 구현하기 - Dev Joon&url=https://han-joon-hyeok.github.io/posts/aws-s3-presigned-url-upload-with-java-spring-and-next-js/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/c-bitwise-operation-between-different-integer-sizes/">[C언어] 자료형 크기 차이로 인한 비트 연산 오류 해결 방법</a><li><a href="/posts/connect-to-ec2-without-ssh-key-using-session-manager/">[AWS] EC2 인스턴스 ssh 키 없이 터미널 접속하는 방법 (AWS Session Manager)</a><li><a href="/posts/how-to-access-geo-restricted-websites-using-mullvad-vpn/">국가 제한이 걸린 사이트에 접속하는 방법 (feat. Mullvad VPN)</a><li><a href="/posts/network-overview/">네트워크 LAN, WAN / 스위치, 라우터 / IP 주소 / 서브넷 개념 정리</a><li><a href="/posts/what-is-nat/">NAT란?</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/programmers/">programmers</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/level2/">level2</a> <a class="post-tag" href="/tags/level1/">level1</a> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/pipex/">pipex</a> <a class="post-tag" href="/tags/born2beroot/">born2beroot</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/data-structure/">Data Structure</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/next-js-failed-to-load-swc-binary/"><div class="card-body"> <span class="timeago small" > Mar 4, 2024 <i class="unloaded">2024-03-04T00:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Next.js] Failed to load SWC binary for linux/x64 해결 방법</h3><div class="text-muted small"><p> 실행 환경 OS: MacOS(Intel) Sonoma 14.2.1 Node : 21.1.0 npm : 10.5.0 문제 상황 Next.js 개발 서버를 실행하기 위해 npm run dev 를 실행했다. 하지만 Failed to load SWC binary for linux/x64, see more info here: htt...</p></div></div></a></div><div class="card"> <a href="/posts/java-spring-problem-occured-configuring-root-project/"><div class="card-body"> <span class="timeago small" > Mar 4, 2024 <i class="unloaded">2024-03-04T17:35:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Java Spring] A problem occured configuring root project 오류 해결 방법</h3><div class="text-muted small"><p> 실행 환경 OS : MacOS(Intel) Sonoma 14.2.1 IntelliJ : Ultimate 2023.2.5 문제 상황 스프링 프로젝트를 실행하려고 했지만 A problem occured configuring root project 으로 시작하는 오류가 발생했다. 문제 원인 스프링 프로젝트 세팅 시 자바 17 버전을 ...</p></div></div></a></div><div class="card"> <a href="/posts/java-spring-postgres-connection/"><div class="card-body"> <span class="timeago small" > Mar 4, 2024 <i class="unloaded">2024-03-04T19:35:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Java Spring] PostgreSQL 연동이 안될 때 해결 방법 (Failed to configure a DataSource)</h3><div class="text-muted small"><p> 실행 환경 OS : MacOS(Intel) Sonoma 14.2.1 Java : 17 Spring Boot : 3.2.3 IntelliJ Ultimate : 2023.2.6 문제 상황 PostgreSQL 과 Spring 을 연동하는 작업을 진행하고 있었다. Spring 프로젝트의 설정은 spring intializer ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/java-spring-jackson-is-prefix-removed/" class="btn btn-outline-primary" prompt="Older"><p>[Java Spring] is 로 시작하는 변수의 이름이 json 객체에서 is 가 사라지는 문제</p></a> <a href="/posts/programmers-data-analysis/" class="btn btn-outline-primary" prompt="Newer"><p>프로그래머스 Level 1 - [PCCE 기출문제] 10번 / 데이터 분석 (Java)</p></a></div><script src="https://utteranc.es/client.js" repo="Han-Joon-Hyeok/Han-Joon-Hyeok.github.io" issue-term="pathname" label="Comments" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/han-joon-hyeok">Joon Hyeok Han</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/programmers/">programmers</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/level2/">level2</a> <a class="post-tag" href="/tags/level1/">level1</a> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/pipex/">pipex</a> <a class="post-tag" href="/tags/born2beroot/">born2beroot</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/data-structure/">Data Structure</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://han-joon-hyeok.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
