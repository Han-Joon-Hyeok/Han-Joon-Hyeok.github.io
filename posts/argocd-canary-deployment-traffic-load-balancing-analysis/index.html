<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.0" /><meta property="og:title" content="[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱" /><meta name="author" content="Joon Hyeok Han" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="개요" /><meta property="og:description" content="개요" /><link rel="canonical" href="https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/" /><meta property="og:url" content="https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/" /><meta property="og:site_name" content="Dev Joon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-11-17T21:10:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Joon Hyeok Han" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joon Hyeok Han"},"dateModified":"2024-11-17T21:10:00+09:00","datePublished":"2024-11-17T21:10:00+09:00","description":"개요","headline":"[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱","mainEntityOfPage":{"@type":"WebPage","@id":"https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/"},"url":"https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/"}</script><title>[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱 | Dev Joon</title><link rel="shortcut icon" href="/assets/images/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/images/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/images/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/images/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/images/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/images/favicons/manifest.json"><meta name='msapplication-config' content='/assets/images/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SKST7KNWSJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SKST7KNWSJ'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/profile.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dev Joon</a></div><div class="site-subtitle font-italic">성장하는 개발자, 한준혁입니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Han-Joon-Hyeok" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['joonhyeok.han','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 17, 2024, 9:10 PM +0900" > Nov 17, 2024 <i class="unloaded">2024-11-17T21:10:00+09:00</i> </span> by <span class="author"> Joon Hyeok Han </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1323 words">7 min</span></div></div><div class="post-content"><h1 id="개요">개요</h1><p>ArgoCD에서 지원하는 무중단 배포 전략 중 하나인 canary 전략을 사용해서 업데이트를 진행할 때, 파드의 개수에 따라 트래픽의 로드 밸런싱이 어떻게 이루어지는지 정리했다.</p><h1 id="canary">canary</h1><h2 id="개념">개념</h2><p>새롭게 업데이트 하는 버전을 v2, 기존 실행하고 있는 버전을 v1이라고 해보자. canary 배포 전략에서는 v1에 보내던 트래픽을 v2로 점진적으로 옮긴다. 즉, 배포를 하는 중이라면 일부 트래픽은 v2로 가고, 나머지 트래픽은 v1으로 간다는 것이다. 이러한 특징 때문에 A/B 테스트에 사용되기도 한다.</p><p>ArgoCD의 canary 배포 전략은 v2에 새롭게 생성한 파드의 개수에 비례해서 트래픽을 분산하는 방식을 채택하고 있다.</p><p>예를 들어, 5개의 파드가 있고, 트래픽 분산 비중(weight)을 20%, 40%, 60%, 80% 점진적으로 증가시킨다고 해보자. 여기서 퍼센트는 새로운 버전으로 보낼 트래픽의 비중을 의미한다.</p><p>비중에 따른 v1, v2 버전의 파드 개수와 전체 트래픽 분산 비율은 다음의 표와 같이 변화한다.</p><div class="table-wrapper"><table><thead><tr><th> <th>v1 파드 개수 - 전체 트래픽 비율<th>v2 파드 개수 - 전체 트래픽 비율<tbody><tr><td>0%<td>5 - 100%<td>0 - 0%<tr><td>20%<td>5 - 80%<td>1 - 20%<tr><td>40%<td>5 - 60%<td>2 - 40%<tr><td>60%<td>5 - 40%<td>3 - 60%<tr><td>80%<td>5 - 20%<td>4 - 80%<tr><td>100%<td>0 - 0%<td>5 - 100%</table></div><p>새로운 버전으로 업데이트가 끝날 때까지, 즉 트래픽을 100% 옮기기 전까지는 v1 버전 파드를 유지한다.</p><p>그렇기 때문에 canary 배포 전략은 blue/green 배포 전략처럼 배포하는 과정에서 리소스를 평소보다 약 2배 정도 사용해야 한다.</p><h2 id="트래픽-분산-테스트">트래픽 분산 테스트</h2><p>개념적으로는 이해했지만, 실제로 트래픽이 트래픽 분산 비중(weight)에 따라 분산되는지 확인하기 위해 테스트를 진행했다.</p><h3 id="테스트-환경">테스트 환경</h3><p>파드는 nginx와 tcpdump를 함께 설치된 이미지로 파드를 실행했다.</p><p>weight는 20, 40, 60, 80 순으로 증가하도록 했으며, 30초 간격으로 파드를 새롭게 생성하도록 했다.</p><h3 id="yaml-파일-코드">yaml 파일 코드</h3><p>Helm Chart를 이용해서 Application을 생성했다.</p><p>디렉토리 구조는 다음과 같다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">.</span>
├── Chart.yaml
├── templates
│   ├── rollout.yaml
│   └── service.yaml
└── values.yaml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">rollout.yaml</code> 파일은 다음과 같다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">argoproj.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Rollout</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">-rollout</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> 
    <span class="na">chart</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-"</span>
    <span class="na">release</span><span class="pi">:</span> 
    <span class="na">heritage</span><span class="pi">:</span> 
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> 
  <span class="na">revisionHistoryLimit</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> 
      <span class="na">release</span><span class="pi">:</span> 
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">canary</span><span class="pi">:</span>
      <span class="na">canaryService</span><span class="pi">:</span> <span class="s">-canary</span>
      <span class="na">stableService</span><span class="pi">:</span> <span class="s">-stable</span>
      <span class="na">steps</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">20</span>
        <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">duration</span><span class="pi">:</span> <span class="nv">30s</span><span class="pi">}</span>
        <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">40</span>
        <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">duration</span><span class="pi">:</span> <span class="nv">30s</span><span class="pi">}</span>
        <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">60</span>
        <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">duration</span><span class="pi">:</span> <span class="nv">30s</span><span class="pi">}</span>
        <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">80</span>
        <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">duration</span><span class="pi">:</span> <span class="nv">30s</span><span class="pi">}</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> 
        <span class="na">release</span><span class="pi">:</span> 
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> 
          <span class="na">image</span><span class="pi">:</span> 
          <span class="na">resources</span><span class="pi">:</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
              <span class="na">containerPort</span><span class="pi">:</span> 
              <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">service.yaml</code> 파일은 다음과 같다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> 
  <span class="na">name</span><span class="pi">:</span> <span class="s">-canary</span>
  <span class="na">namespace</span><span class="pi">:</span> 
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> 
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">targetPort</span><span class="pi">:</span> 
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> 
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> 
  <span class="na">name</span><span class="pi">:</span> <span class="s">-stable</span>
  <span class="na">namespace</span><span class="pi">:</span> 
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> 
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">targetPort</span><span class="pi">:</span> 
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> 
</pre></table></code></div></div><p>서비스는 canary, stable 2개이며, stable 서비스는 NodePort 를 이용해서 <code class="language-plaintext highlighter-rouge">localhost:port</code> 로 접근할 수 있도록 했다.</p><p><code class="language-plaintext highlighter-rouge">values.yaml</code> 파일은 다음과 같다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="na">app</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">demo-rollout"</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">giafar/nginx:1.25.1-tcpdump"</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1m"</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">128Mi"</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1m"</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">128Mi"</span>

<span class="na">podAnnotations</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">podLabels</span><span class="pi">:</span>
  <span class="na">tier</span><span class="pi">:</span> <span class="s">backend</span>

<span class="na">service</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
</pre></table></code></div></div><p>패킷이 들어오는지 확인하기 위해 tcpdump가 설치된 nginx 이미지를 사용했다.</p><p>각 파드에서 tcpdump 를 실행하고 <code class="language-plaintext highlighter-rouge">curl localhost:port</code> 명령어를 실행해서 패킷 수신을 확인했다.</p><p>파드 접속은 아래의 명령어를 이용했다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="o">[</span>namespace] <span class="o">[</span>pod-name] <span class="nt">--</span> /bin/sh
</pre></table></code></div></div><h3 id="파드가-1개일-때">파드가 1개일 때</h3><p>v2 파드에서 tcpdump 를 실행한 상태로 <code class="language-plaintext highlighter-rouge">curl</code> 을 실행했지만, weight가 100이 될 때까지 v2 파드에는 트래픽이 분산되지 않았다.</p><p>weight가 20이면 트래픽을 v1 파드에 80%, v2 파드에 20% 분산해줄 것으로 예상했는데, 그렇지 않았다.</p><h3 id="파드가-5개일-때">파드가 5개일 때</h3><p>v1 파드에서 tcpdump 실행한 상태로 <code class="language-plaintext highlighter-rouge">curl</code> 을 실행하니 weight 가 증가할수록 점점 패킷 수신이 줄었다.</p><p>이를 통해 weight는 파드의 개수에 비례해서 분배 해주는 것 같다.</p><h2 id="기타">기타</h2><ul><li>파드 개수를 줄이는 것은 revision이 증가하지 않는다.<li>파드가 1개였다가 5개로 바뀌고 이미지도 같이 바뀌면 파드를 먼저 5개로 늘린 다음에 canary 로 하나씩 옮긴다.</ul><h1 id="참고자료">참고자료</h1><ul><li><a href="https://velog.io/@pinion7/Kubernetes-%EB%A6%AC%EC%86%8C%EC%8A%A4-Deployment%EC%97%90-%EB%8C%80%ED%95%B4-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B3%A0-%EC%8B%A4%EC%8A%B5%ED%95%B4%EB%B3%B4%EA%B8%B0">Kubernetes 리소스 Deployment에 대해 이해하고 실습해보기</a> [velog]</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/argocd/'>argocd</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱 - Dev Joon&url=https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[ArgoCD] 무중단 배포 canary 전략의 파드 개수에 따른 로드밸런싱 - Dev Joon&u=https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://han-joon-hyeok.github.io/posts/argocd-canary-deployment-traffic-load-balancing-analysis/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Nest-js-google-typescript-style-with-eslint-and-prettier/">[Nest.js] 협업을 위한 Google TyepScript Style 을 ESLint, Prettier 에 간단하게 적용하기</a><li><a href="/posts/Next-js-google-typescript-style-with-eslint-and-prettier/">[Next.js] 협업을 위한 Google TyepScript Style 을 ESLint, Prettier 에 간단하게 적용하기</a><li><a href="/posts/ubuntu-file-write-permission-denied/">[Linux] 파일 write 작업 시 PermissionError: [Errno 13] Permission denied 오류 해결</a><li><a href="/posts/what-is-arp/">ARP 개념 정리</a><li><a href="/posts/ubuntu-python-crontab-not-working/">[Linux] python 을 crontab 으로 실행하도록 했는데 실행되지 않는 이유 (feat. 상대경로, 절대경로)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/programmers/">programmers</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/level2/">level2</a> <a class="post-tag" href="/tags/level1/">level1</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/pipex/">pipex</a> <a class="post-tag" href="/tags/born2beroot/">born2beroot</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/data-structure/">data structure</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/argo-rollouts-with-appproject/"><div class="card-body"> <span class="timeago small" > Nov 3, 2024 <i class="unloaded">2024-11-03T17:20:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[ArgoCD] RBAC 적용을 위한 AppProject와 무중단 배포를 위한 Argo Rollouts 함께 사용하기</h3><div class="text-muted small"><p> Argo Rollouts 설치(helm) 1. 플레인 쿠버네티스 argo-rollouts 네임스페이스 생성 후 설치 kubectl create ns argo-rollouts helm install argo-rollouts argo/argo-rollouts --version 2.35.1 --namespace argo-rollouts 2. EKS...</p></div></div></a></div><div class="card"> <a href="/posts/argocd-hpa-with-autoscaling-strategies/"><div class="card-body"> <span class="timeago small" > Nov 10, 2024 <i class="unloaded">2024-11-10T15:50:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[ArgoCD] 무중단 배포 전략과 함께 HPA 적용하기</h3><div class="text-muted small"><p> 개요 Kubernetes의 HPA(Horizontal Pod Autoscaler) 객체를 활용하여 무중단 배포 전략(Rolling Update, Canary)을 설정하고, 오토스케일링을 구현하는 방법을 정리했다. HPA 개념 출처: Was ist (Kubernetes) Autoscaling? VPA vs. HPA [kreyman] HPA(H...</p></div></div></a></div><div class="card"> <a href="/posts/argocd-custom-trigger-notifications/"><div class="card-body"> <span class="timeago small" > Dec 1, 2024 <i class="unloaded">2024-12-01T16:40:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[ArgoCD] 사용자 정의 트리거(Custom Trigger)를 활용한 알림 설정하기</h3><div class="text-muted small"><p> 개요 ArgoCD에서 제공하는 기본 트리거 외에도 사용자가 새롭게 트리거를 정의하여 알림을 보낼 수 있습니다. ArgoCD와 Argo Rollouts 모두 커스텀 트리거를 지원하며, 적용 방법은 동일하므로 이 글에서는 ArgoCD를 기준으로 설명합니다. 1. Notification ConfigMap 수정 ConfigMap 파일 수정 알림 설정...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/argocd-hpa-with-autoscaling-strategies/" class="btn btn-outline-primary" prompt="Older"><p>[ArgoCD] 무중단 배포 전략과 함께 HPA 적용하기</p></a> <a href="/posts/kubernetes-rolling-update-deployment/" class="btn btn-outline-primary" prompt="Newer"><p>[Kubernetes] Deployment 객체를 활용해서 Rolling Update 무중단 배포 전략 적용하기</p></a></div><script src="https://utteranc.es/client.js" repo="Han-Joon-Hyeok/Han-Joon-Hyeok.github.io" issue-term="pathname" label="Comments" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://github.com/han-joon-hyeok">Joon Hyeok Han</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/programmers/">programmers</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/level2/">level2</a> <a class="post-tag" href="/tags/level1/">level1</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/pipex/">pipex</a> <a class="post-tag" href="/tags/born2beroot/">born2beroot</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/data-structure/">data structure</a> <a class="post-tag" href="/tags/docker/">docker</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://han-joon-hyeok.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
